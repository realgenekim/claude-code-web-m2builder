name: Build M2 Bundle

on:
  push:
    paths:
      - 'bundles/*.edn'
  workflow_dispatch:
    inputs:
      bundle-id:
        description: 'Bundle ID to build (e.g., gcs-client)'
        required: false
        type: string

permissions:
  contents: write  # Required for creating releases

jobs:
  detect-bundles:
    runs-on: ubuntu-latest
    outputs:
      bundles: ${{ steps.find.outputs.bundles }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find changed bundles
        id: find
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.bundle-id }}" ]; then
            # Manual trigger with specific bundle
            BUNDLE_FILE="bundles/${{ github.event.inputs.bundle-id }}.edn"
            if [ -f "$BUNDLE_FILE" ]; then
              echo "bundles=[\"$BUNDLE_FILE\"]" >> $GITHUB_OUTPUT
            else
              echo "Error: Bundle file not found: $BUNDLE_FILE"
              exit 1
            fi
          else
            # Auto-detect changed bundles from push
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^bundles/.*\.edn$' || echo "")
            if [ -z "$CHANGED" ]; then
              echo "No bundle files changed"
              echo "bundles=[]" >> $GITHUB_OUTPUT
            else
              # Convert to JSON array
              BUNDLES=$(echo "$CHANGED" | jq -R -s -c 'split("\n") | map(select(length > 0))')
              echo "bundles=$BUNDLES" >> $GITHUB_OUTPUT
              echo "Changed bundles: $BUNDLES"
            fi
          fi

  build-bundle:
    needs: detect-bundles
    if: needs.detect-bundles.outputs.bundles != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bundle-file: ${{ fromJSON(needs.detect-bundles.outputs.bundles) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: 1.11.3.1463

      - name: Extract bundle metadata
        id: meta
        run: |
          BUNDLE_FILE="${{ matrix.bundle-file }}"
          BUNDLE_ID=$(basename "$BUNDLE_FILE" .edn)

          # Extract description and size estimate from EDN
          DESCRIPTION=$(grep ':description' "$BUNDLE_FILE" | sed 's/.*:description "\([^"]*\)".*/\1/' || echo "No description")
          SIZE_EST=$(grep ':size-estimate-mb' "$BUNDLE_FILE" | grep -o '[0-9]\+' || echo "unknown")

          echo "bundle-id=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "size-estimate=$SIZE_EST" >> $GITHUB_OUTPUT

          echo "Building bundle: $BUNDLE_ID"
          echo "Description: $DESCRIPTION"
          echo "Estimated size: ${SIZE_EST} MB"

      - name: Create temp M2 directory
        run: |
          TMP_M2="/tmp/m2-${{ steps.meta.outputs.bundle-id }}"
          echo "TMP_M2=$TMP_M2" >> $GITHUB_ENV
          mkdir -p "$TMP_M2"

      - name: Warm M2 cache
        run: |
          BUNDLE_FILE="${{ matrix.bundle-file }}"

          echo "Downloading dependencies..."
          echo "This may take several minutes for large bundles..."

          # Create temp directory with bundle file as deps.edn
          TEMP_DIR="/tmp/bundle-build-$$"
          mkdir -p "$TEMP_DIR"
          cp "$BUNDLE_FILE" "$TEMP_DIR/deps.edn"

          # Change to temp dir and run clojure (it will use deps.edn there)
          cd "$TEMP_DIR"
          clojure -Srepro -Sforce \
                  -Sdeps "{:mvn/local-repo \"$TMP_M2\"}" \
                  -P

          # Cleanup temp dir
          cd -
          rm -rf "$TEMP_DIR"

          echo "Dependencies downloaded successfully!"

      - name: Create tarball
        id: tarball
        run: |
          BUNDLE_ID="${{ steps.meta.outputs.bundle-id }}"
          TARBALL="m2-${BUNDLE_ID}.tar.gz"

          echo "Creating tarball: $TARBALL"
          tar czf "$TARBALL" -C /tmp "m2-${BUNDLE_ID}"

          # Get sizes
          SIZE_UNCOMPRESSED=$(du -sm "$TMP_M2" | cut -f1)
          SIZE_COMPRESSED=$(du -m "$TARBALL" | cut -f1)
          ARTIFACT_COUNT=$(find "$TMP_M2" -name "*.jar" | wc -l)

          echo "tarball-name=$TARBALL" >> $GITHUB_OUTPUT
          echo "size-uncompressed=$SIZE_UNCOMPRESSED" >> $GITHUB_OUTPUT
          echo "size-compressed=$SIZE_COMPRESSED" >> $GITHUB_OUTPUT
          echo "artifact-count=$ARTIFACT_COUNT" >> $GITHUB_OUTPUT

          echo "Bundle statistics:"
          echo "  Uncompressed: ${SIZE_UNCOMPRESSED} MB"
          echo "  Compressed: ${SIZE_COMPRESSED} MB"
          echo "  JAR files: ${ARTIFACT_COUNT}"

      - name: Upload artifact (temp)
        uses: actions/upload-artifact@v4
        with:
          name: m2-${{ steps.meta.outputs.bundle-id }}
          path: ${{ steps.tarball.outputs.tarball-name }}
          retention-days: 1

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: m2-bundles
          name: M2 Bundles
          draft: false
          prerelease: false
          body: |
            # M2 Dependency Bundles

            Community-maintained Maven/Clojure dependency bundles for sandboxed environments.

            ## Available Bundles

            See [bundles/README.md](https://github.com/${{ github.repository }}/blob/main/bundles/README.md) for the complete list.

            ## Usage

            ```bash
            # Download a bundle
            curl -L -O https://github.com/${{ github.repository }}/releases/download/m2-bundles/m2-BUNDLE-ID.tar.gz

            # Extract
            tar xzf m2-BUNDLE-ID.tar.gz -C ~/.m2-cache/

            # Use with Clojure
            clojure -Sdeps '{:mvn/local-repo "~/.m2-cache/m2-BUNDLE-ID"}' ...
            ```

            ## Documentation

            See [docs/INDEX.md](https://github.com/${{ github.repository }}/blob/main/docs/INDEX.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: m2-bundles
          files: ${{ steps.tarball.outputs.tarball-name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ✅ Bundle Built: ${{ steps.meta.outputs.bundle-id }}

          **Description**: ${{ steps.meta.outputs.description }}

          **Statistics**:
          - Uncompressed: ${{ steps.tarball.outputs.size-uncompressed }} MB
          - Compressed: ${{ steps.tarball.outputs.size-compressed }} MB
          - JAR files: ${{ steps.tarball.outputs.artifact-count }}
          - Estimated size: ${{ steps.meta.outputs.size-estimate }} MB

          **Download URL**:
          \`\`\`
          https://github.com/${{ github.repository }}/releases/download/m2-bundles/m2-${{ steps.meta.outputs.bundle-id }}.tar.gz
          \`\`\`

          **Usage**:
          \`\`\`bash
          curl -L -O https://github.com/${{ github.repository }}/releases/download/m2-bundles/m2-${{ steps.meta.outputs.bundle-id }}.tar.gz
          tar xzf m2-${{ steps.meta.outputs.bundle-id }}.tar.gz -C ~/.m2-cache/
          clojure -Sdeps '{:mvn/local-repo "~/.m2-cache/m2-${{ steps.meta.outputs.bundle-id }}"}' ...
          \`\`\`
          EOF

      - name: Comment on commit (if push)
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const bundleId = '${{ steps.meta.outputs.bundle-id }}';
            const sizeCompressed = '${{ steps.tarball.outputs.size-compressed }}';
            const artifactCount = '${{ steps.tarball.outputs.artifact-count }}';
            const downloadUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/m2-bundles/m2-${bundleId}.tar.gz`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `✅ Bundle **${bundleId}** built successfully!\n\n- Size: ${sizeCompressed} MB\n- Artifacts: ${artifactCount} JARs\n- Download: ${downloadUrl}`
            });
